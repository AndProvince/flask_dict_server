{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Пользователи</h2>
  <div class="text-muted">
    Администраторов: {{ admins_count }}
  </div>
</div>

<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th>ID</th>
      <th>Логин</th>
      <th>Роль</th>
      <th style="width: 340px;">Действия</th>
    </tr>
  </thead>
  <tbody>
    {% for u in users %}
    <tr>
      <td>{{ u.id }}</td>
      <td>
        {{ u.username }}
        {% if me_id == u.id %}
          <span class="badge bg-secondary">Вы</span>
        {% endif %}
      </td>
      <td>
        {% if u.is_admin %}
          <span class="badge bg-success">Администратор</span>
        {% else %}
          <span class="badge bg-light text-dark">Пользователь</span>
        {% endif %}
      </td>
      <td>
        <!-- Кнопка раскрытия формы смены пароля -->
        <button class="btn btn-sm btn-outline-primary me-2" type="button"
                data-bs-toggle="collapse" data-bs-target="#pwd-{{ u.id }}"
                aria-expanded="false" aria-controls="pwd-{{ u.id }}">
          Сменить пароль
        </button>

        <!-- Удаление пользователя -->
        <form action="{{ url_for('users_admin.delete_user', user_id=u.id) }}"
              method="post" class="d-inline"
              onsubmit="return confirm('Удалить пользователя {{ u.username }}?');">
          <button class="btn btn-sm btn-outline-danger"
                  {% if me_id == u.id or (u.is_admin and admins_count <= 1) %}disabled{% endif %}>
            Удалить
          </button>
        </form>

        <!-- Форма смены пароля (collapse) -->
        <div class="collapse mt-2" id="pwd-{{ u.id }}">
          <form class="row g-2 align-items-center mt-2"
                action="{{ url_for('users_admin.change_password', user_id=u.id) }}"
                method="post" style="max-width: 520px;">
            <div class="col-auto">
              <input class="form-control form-control-sm" type="password"
                     name="new_password" placeholder="Новый пароль" minlength="6" required>
            </div>
            <div class="col-auto">
              <input class="form-control form-control-sm" type="password"
                     name="new_password2" placeholder="Повторите пароль" minlength="6" required>
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-primary" type="submit">Сохранить</button>
            </div>
          </form>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
